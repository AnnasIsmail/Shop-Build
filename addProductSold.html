<!DOCTYPE html>
<html lang="en">
<head>
    <title>Shop Build</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/logo-shop-build.png">
    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/leftBar.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/navbarAfterLogin.css">
    <link rel="stylesheet" href="css/detailProduct.css">
</head>
<body>
   
    <nav class="navbar navbar-after-login">
        <div >
            <a href="index.html" class="logo-navbar">
                <img src="assets/logo-shop-build.png" alt="">
                Shop Build
            </a>
        </div>
        <div class="profile noselect" onclick="toogleDropdown()">
            <img src="assets/profile.png" class="profile-image" alt="">
            <b id="profileName"></b>
            <img src="assets/down-arrow.svg" class="profile-arrow" alt="">
        </div>
        <span class="dropdown hidden noselect" id="dropdownAfterLogin">
            <a href="">Edit Profile</a>
            <a onclick="logOut()">Log Out</a>
        </span>
    </nav>

    <div class="leftBar">
        <a href="dashboard.html"> <img src="assets/dashboard.svg" alt=""> Dashboard</a>
        <a href="listProduct.html"> <img src="assets/darfat-product.svg" alt=""> List Product</a>
        <a href="productSold.html"> <img src="assets/Product-Sold.svg" alt=""> Product Sold</a>
        <a href="editProfile.html"> <img src="assets/Profile.svg" alt=""> Edit Profile</a>
        <a href="" onclick="logOut()"> <img src="assets/Sign_out.svg" alt=""> Log Out</a>
    </div>

    <main class="list-product">
        <header><h1>Edit Product Sold</h1></header>
        <div class="container-list-product">

            <form class="container-detail-product" onsubmit="return false">
                <p class="error-massage hidden oneCol" id="errorSubmit"></p>
                <label for="">Name Customer :</label>
                <input type="text" id="name" onfocus="focuss()">
                <label for="">No Handphone :</label>
                <input type="number" id="nhp" onfocus="focuss()">
            </form>

            <table id="table">
                <tr class="border-header">
                    <th onclick="sortByNo()" class="bold-table">No</th>
                    <th onclick="sortByName()" class="bold-table">Nama Product</th>
                    <th onclick="sortByNP()" class="bold-table">Price</th>
                    <th onclick="sortByQTY()" class="bold-table">Qty</th>
                    <th onclick="sortByDate()" class="bold-table">Total</th>
                    <th class="bold-table">Action</th>
                </tr>

            </table>

            <form class="container-detail-product" onsubmit="return false">
     
                <label for="">Product :</label>
                <select name="products" id="products">
     
               </select>
     
                <label for="">Qty :</label>
                <input type="number" id="qty"  onfocus="focuss()">

                <div class="oneCol">
                    <button type="submit" id="submitButton" onclick="addData()">Add</button>
               </div>

                <div class="container-button">
                     <button onclick="goToProductSold()">Cancel</button>
                     <button type="submit" id="submitButton" onclick="submitEdit()">Submit</button>
                </div>
             </form>

        </div>
    </main>


    <script>
        page='dashboard';
        login='after';

    </script>

    <script src="js/navbar.js"></script>
    <script src="js/source.js"></script>
    <script src="js/checkLogin.js"></script>
    <script>checkLogin()</script>

    <script>
        dataUser = {};

        user.forEach(data => {
            if(data.id === parseInt(localStorage.idUser)){
                dataUser = data;
            }
        });
        space = dataUser.name.indexOf(' ');
        document.getElementById('profileName').innerHTML = dataUser.name.substring(0 , space);

        addProductSoldId = 0;

        productSold.forEach(data => {
            addProductSoldId = parseInt(data.id)+1
        });


        total = 0;
        
        function getDataProduct(){


        product.forEach((data , index) => {
            
            let select = document.createElement('option');
            select.setAttribute('value', data.id);
            select.innerHTML = data.name;
            document.getElementById('products').appendChild(select);

        });

        tableDataProduct = [];

        detailProductSold.forEach((data , index)=>{
            if(parseInt(data.idSold) === parseInt(addProductSoldId)){
                namaProduct = '';
                price = 0;
                idProduct = 0;

                product.forEach(dataPro => {
                    if(parseInt(dataPro.id) === parseInt(data.idProduct)){
                        price = dataPro.price;
                        namaProduct = dataPro.name
                        idProduct = dataPro.id
                    }
                });
                
                ObjectData = {
                    id: index+1,
                    idProduct: idProduct,
                    namaProduct: namaProduct,
                    price: price,
                    qty: data.qty,
                    total: price*data.qty,
                };

                tableDataProduct.push(ObjectData)
            }
        });
    }

    getDataProduct()

        function tampilData(dataLoop){
            document.getElementById('table').innerHTML = '';
            document.getElementById('table').innerHTML = `            
            <tr class="border-header">
                    <th onclick="sortByNo()" class="bold-table">No</th>
                    <th onclick="sortByName()" class="bold-table">Nama Product</th>
                    <th onclick="sortByNP()" class="bold-table">Price</th>
                    <th onclick="sortByQTY()" class="bold-table">Qty</th>
                    <th onclick="sortByDate()" class="bold-table">Total</th>
                    <th class="bold-table">Action</th>
                </tr>`;

            dataLoop.forEach((data , index)=>{
    
                    const tr = document.createElement('tr');
        
                    const tdNo = document.createElement('td');
                    tdNo.innerHTML = index+1
                    tr.appendChild(tdNo);
        
                    const tdName = document.createElement('td');
                    tdName.innerHTML = data.namaProduct
                    tr.appendChild(tdName);
    
                    const tdStock = document.createElement('td');
                    tdStock.innerHTML = data.price
                    tr.appendChild(tdStock);
    
                    const tdBy = document.createElement('td');
                    tdBy.innerHTML = data.qty
                    tr.appendChild(tdBy);
    
                    const tdDate = document.createElement('td');
                    tdDate.innerHTML = data.total
                    tr.appendChild(tdDate);
        
                    const tdAction = document.createElement('td');
                    tdAction.innerHTML = `<img src="assets/Delete.svg" class="cursor" onclick="goToRemove(${data.idProduct})" alt="">`
                    tr.appendChild(tdAction);
                    
                    document.getElementById('table').appendChild(tr);

                
            })

        }

        tampilData(tableDataProduct);

        function sortByNo(){
            tableDataProduct.sort((a, b) => {
                return a.id - b.id;
            });
            tampilData(tableDataProduct);
        }

        function sortByName(){
            tableDataProduct.sort((a, b) => {
                let fa = a.namaProduct.toLowerCase(),
                    fb = b.namaProduct.toLowerCase();

                if (fa < fb) {
                    return -1;
                }
                if (fa > fb) {
                    return 1;
                }
                return 0;
            });
            tampilData(tableDataProduct);
        }

        function sortByNP(){
            tableDataProduct.sort((a, b) => {
                return a.price - b.price;
            });
            tampilData(tableDataProduct);
        }

        function sortByQTY(){
            tableDataProduct.sort((a, b) => {
                return a.qty - b.qty;
            });
            tampilData(tableDataProduct);
        }

        function focuss(){
            document.getElementById('errorSubmit').classList.add('hidden');
        }

        function sortByDate(){
            tableDataProduct.sort((a, b) => {
                return a.total - b.total;
            });
            tampilData(tableDataProduct);
        }

        function validationAddData(){
            res = false;

                tableDataProduct.forEach(data => {
                    if(data.namaProduct === document.getElementById("products").options[document.getElementById("products").selectedIndex].text){
                        document.getElementById('errorSubmit').classList.remove('hidden');
                        document.getElementById('errorSubmit').innerHTML = 'Mohon Masukan Produk secara berkala. tidak dapat memasukan dua produk yang sama dalam satu transaksi.';
                         res = false;
                    }else{
                        res = true;
                    }
                })

                if(document.getElementById("qty").value === ''){
                    document.getElementById('errorSubmit').classList.remove('hidden');
                    document.getElementById('errorSubmit').innerHTML = 'Pastikan Seluruh Field sudah terisi!';
                    res = false;
                }

                if(tableDataProduct.length === 0){
                    res = true;
                }

            return res;
        }

        function addData(){
            valid = validationAddData();
            console.log(valid)
            if(valid === true){
                dataArray = [];
                dataDetail = {
                    idSold: parseInt(addProductSoldId),
                    idProduct: parseInt(document.getElementById("products").value),
                    qty: parseInt(document.getElementById("qty").value)
                };
                detailProductSold.forEach(data=>{
                    dataArray.push(data);
                });
                dataArray.push(dataDetail);
    
                localStorage.setItem('detailProductSold', JSON.stringify(dataArray));
                detailProductSold = dataArray;
    
                getDataProduct()
                tampilData(tableDataProduct);
            }
        }
    
        function goToRemove(id){
            dataArray = [];
            detailProductSold.forEach(data=>{
                if(parseInt(id) === parseInt(data.idProduct) && parseInt(addProductSoldId) === parseInt(data.idSold)){

                }else{
                    dataArray.push(data);
                }
            });

            localStorage.setItem('detailProductSold', JSON.stringify(dataArray));
                detailProductSold = dataArray;
    
                getDataProduct()
                tampilData(tableDataProduct);
        }


        function validation(){
            if(document.getElementById('name').value === "" || document.getElementById('nhp').value === "" ){
                document.getElementById('errorSubmit').classList.remove('hidden');
                document.getElementById('errorSubmit').innerHTML = 'Pastikan Seluruh Field sudah terisi!';
                return false;
            }else{
                return true;
            }
        }

        function goToProductSold(){
            document.location.href = 'productSold.html';

        }

        function submitEdit(){
            
            valid = validation();

            if(valid === true){
    
                months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                dateNow = new Date();

                month = months[dateNow.getMonth()];
                tanggal = dateNow.getDate();
                year = dateNow.getFullYear();

                let date = `${month} ${tanggal}, ${year}`

                dataAfterEdit = {
                    id: parseInt(addProductSoldId),
                    customerName: document.getElementById('name').value,
                    noHandphone: document.getElementById('nhp').value,
                    date: date,
                };
                
                productEdit = [];
    
                productSold.forEach(data => {
                    productEdit.push(data);
                });
                productEdit.push(dataAfterEdit);
    
                localStorage.setItem('productSold', JSON.stringify(productEdit));
                productSold = productEdit;
                goToProductSold();
            }
        }

    </script>
</body>
</html>
